{%- doc -%}
  Renders the gift with purchase selection UI in the cart.
{%- enddoc -%}

{%- liquid
  assign gwp_section = section
  
  if gwp_section == blank or gwp_section.settings == blank
    assign gwp_enabled = false
    assign cart_threshold = 0
    assign gift_products = blank
    assign vip_enabled = false
    assign vip_tag = 'VIP'
    assign vip_product = blank
    assign vip_test_mode = false
  else
    assign gwp_enabled = gwp_section.settings.enabled
    assign cart_threshold = gwp_section.settings.cart_threshold | times: 100
    assign gift_products = gwp_section.settings.gift_products
    assign vip_enabled = gwp_section.settings.vip_enabled
    assign vip_tag = gwp_section.settings.vip_tag | default: 'VIP'
    assign vip_product = gwp_section.settings.vip_product
    assign vip_test_mode = gwp_section.settings.vip_test_mode
  endif
  
  assign cart_total = cart.total_price
  assign meets_threshold = false
  if cart_total >= cart_threshold
    assign meets_threshold = true
  endif
  
  assign has_gift_products = false
  if gift_products != blank and gift_products.size > 0
    assign has_gift_products = true
  endif
  
  comment
    Component should always be visible when GWP is enabled and has products.
    Visibility of products/actions will be controlled by JavaScript based on threshold.
  endcomment
  
  assign current_gift_variant_id = null
  assign has_gift_in_cart = false
  for item in cart.items
    if item.properties._gwp == 'true'
      assign current_gift_variant_id = item.variant_id
      assign has_gift_in_cart = true
      break
    endif
  endfor
  
  comment
    Check VIP customer status and VIP gift in cart
    In test mode, treat all customers as VIP
  endcomment
  assign is_vip_customer = false
  if vip_test_mode
    assign is_vip_customer = true
  else
    if customer and customer.tags != blank
      if customer.tags contains vip_tag
        assign is_vip_customer = true
      endif
    endif
  endif
  
  assign vip_product_variant_id = null
  assign has_vip_gift_in_cart = false
  if is_vip_customer and vip_product != blank and vip_product.available
    assign vip_product_variant_id = vip_product.selected_or_first_available_variant.id
    for item in cart.items
      if item.properties._vip_gift == 'true'
        assign has_vip_gift_in_cart = true
        break
      endif
    endfor
  endif
  
  comment
    Component should render if GWP is enabled with products, OR if VIP is enabled
  endcomment
  assign should_render = false
  if gwp_enabled and has_gift_products
    assign should_render = true
  endif
  if vip_enabled and is_vip_customer and vip_product != blank and vip_product.available
    assign should_render = true
  endif
-%}

{%- if should_render -%}
  <script
    src="{{ 'gift-with-purchase.js' | asset_url }}"
    type="module"
    fetchpriority="low"
  ></script>

  <gift-with-purchase-component
    class="gwp-component"
    data-section-id="{{ gwp_section.id | default: 'gift-with-purchase' }}"
    data-gwp-enabled="{% if gwp_enabled %}true{% else %}false{% endif %}"
    data-cart-threshold="{{ cart_threshold }}"
    data-current-gift-variant-id="{{ current_gift_variant_id }}"
    data-has-gift-in-cart="{% if current_gift_variant_id %}true{% else %}false{% endif %}"
    data-has-gift-in-cart="{{ has_gift_in_cart }}"
    data-cart-total="{{ cart_total }}"
    data-vip-enabled="{% if vip_enabled %}true{% else %}false{% endif %}"
    data-is-vip-customer="{% if is_vip_customer %}true{% else %}false{% endif %}"
    data-vip-product-variant-id="{{ vip_product_variant_id }}"
    data-has-vip-gift-in-cart="{% if has_vip_gift_in_cart %}true{% else %}false{% endif %}"
    {% if gwp_section.shopify_attributes %}{{ gwp_section.shopify_attributes }}{% endif %}
  >
    <div class="gwp">
      {%- if gwp_enabled -%}

      <div class="gwp__header">
        <div class="gwp__header-content">
          <h3 class="gwp__title">
            {% assign threshold = cart_threshold | money %}
            {{ 'gwp.title' | t: threshold: threshold }}
          </h3>
        </div>
        <button
          type="button"
          class="gwp__close-button"
          aria-label="{{ 'actions.close' | t }}"
          data-gwp-close-button
        >
          <span class="gwp__close-icon" aria-hidden="true">
            {{ 'icon-close.svg' | inline_asset_content }}
          </span>
        </button>
      </div>

      <div
        class="gwp__progress"
        data-gwp-progress
        data-remaining-text="{{ 'gwp.progress.remaining' | t }}"
        data-qualified-text="{{ 'gwp.progress.qualified' | t }}"
        data-add-more-text="{{ 'gwp.progress.add_more' | t }}"
      >
          <div class="gwp__progress-header">
            <span class="gwp__progress-text" data-gwp-progress-text>
              {{ 'gwp.progress.remaining' | t: amount: cart_threshold | minus: cart_total | money }}
            </span>
            <span class="gwp__progress-percentage" data-gwp-progress-percentage>
              {%- liquid
                assign progress_percentage = cart_total | times: 100 | divided_by: cart_threshold
                if progress_percentage > 100
                  assign progress_percentage = 100
                endif
              -%}
              {{ progress_percentage }}%
            </span>
          </div>
          <div class="gwp__progress-bar">
            <div
              class="gwp__progress-fill"
              data-gwp-progress-fill
              style="--progress: {%- liquid
                assign progress_percentage = cart_total | times: 100 | divided_by: cart_threshold
                if progress_percentage > 100
                  assign progress_percentage = 100
                endif
              -%}{{ progress_percentage }}%"
            ></div>
          </div>
          <p class="gwp__progress-message" data-gwp-progress-message>
            {%- if meets_threshold -%}
              {{ 'gwp.progress.qualified' | t }}
            {%- else -%}
              {{ 'gwp.progress.add_more' | t: threshold: cart_threshold | money }}
            {%- endif -%}
          </p>
        </div>
      {%- endif -%}

      {%- if gwp_enabled -%}
      <div
        class="gwp__products{% unless meets_threshold %} gwp__products--hidden{% endunless %}"
        data-gwp-products
      >
        <p class="gwp__description">
          {{ 'gwp.description' | t }}
        </p>
        {%- for product in gift_products -%}
          {%- if product.available -%}
            {%- assign default_variant = product.selected_or_first_available_variant -%}
            <div
              class="gwp__product{% if current_gift_variant_id == default_variant.id %} gwp__product--selected{% endif %}"
              data-product-id="{{ product.id }}"
              data-variant-id="{{ default_variant.id }}"
            >
              <label class="gwp__product-label">
                <input
                  type="radio"
                  name="gwp-selection"
                  value="{{ default_variant.id }}"
                  class="gwp__product-radio"
                  {% if current_gift_variant_id == default_variant.id %}checked{% endif %}
                />
                <div class="gwp__product-content">
                  {%- if product.featured_image -%}
                    <div class="gwp__product-image">
                      {{
                        product.featured_image
                        | image_url: width: 150
                        | image_tag: loading: 'lazy', alt: product.title
                      }}
                    </div>
                  {%- endif -%}
                  <div class="gwp__product-info">
                    <span class="gwp__product-title">{{ product.title }}</span>
                    {%- if product.variants.size > 1 -%}
                      <span class="gwp__product-variant">
                        {{ default_variant.title }}
                      </span>
                    {%- endif -%}
                  </div>
                </div>
              </label>
            </div>
          {%- endif -%}
        {%- endfor -%}
      </div>

      <div
        class="gwp__actions{% unless meets_threshold %} gwp__actions--hidden{% endunless %}"
        data-gwp-actions
      >
        <button
          type="button"
          class="gwp__add-button button button--secondary"
          disabled
          data-original-text="{{ 'gwp.add_gift' | t }}"
          data-change-text="{{ 'gwp.change_gift' | t }}"
        >
          {{ 'gwp.add_gift' | t }}
        </button>
      </div>
      {%- endif -%}
    </div>
  </gift-with-purchase-component>
{%- endif -%}

{% stylesheet %}
  .gwp {
    border: 1px solid var(--color-border);
    border-radius: var(--style-border-radius-inputs);
    padding: var(--padding-md);
    margin-block: var(--margin-md);
    background-color: var(--color-background);
  }

  .gwp__header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: var(--gap-sm);
    margin-bottom: var(--margin-md);
  }

  .gwp__header-content {
    flex: 1;
  }

  .gwp__close-button {
    flex-shrink: 0;
    display: none;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    padding: 0;
    border: none;
    background: transparent;
    color: rgb(var(--color-foreground-rgb) / var(--opacity-70));
    cursor: pointer;
    border-radius: var(--style-border-radius-inputs);
    transition: color var(--animation-speed) var(--animation-easing),
      background-color var(--animation-speed) var(--animation-easing);
  }

  .gwp__close-button:hover {
    color: var(--color-foreground);
    background-color: rgb(var(--color-foreground-rgb) / 0.05);
  }

  .gwp__close-icon {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .gwp__close-icon svg {
    width: 14px;
    height: 14px;
  }

  .gwp-component--editing .gwp__close-button {
    display: flex;
  }

  .gwp__title {
    font-size: var(--font-size-md);
    font-weight: var(--font-weight-bold);
    margin-bottom: var(--margin-xs);
  }

  .gwp__description {
    font-size: var(--font-size-sm);
    color: rgb(var(--color-foreground-rgb) / var(--opacity-70));
    margin: 0;
  }

  .gwp__progress {
    margin-bottom: var(--margin-md);
    padding: var(--padding-sm);
    background-color: rgb(var(--color-foreground-rgb) / 0.03);
    border-radius: var(--style-border-radius-inputs);
  }

  .gwp__progress-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--margin-xs);
  }

  .gwp__progress-text {
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    color: var(--color-foreground);
  }

  .gwp__progress-text--hidden {
    display: none;
  }

  .gwp__progress-percentage {
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-bold);
    color: var(--color-foreground);
  }

  .gwp__progress-bar {
    width: 100%;
    height: 8px;
    background-color: rgb(var(--color-foreground-rgb) / 0.1);
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: var(--margin-xs);
  }

  .gwp__progress-fill {
    height: 100%;
    background-color: var(--color-foreground);
    border-radius: 4px;
    width: var(--progress);
    transition: width 0.3s var(--animation-easing);
    max-width: 100%;
  }

  .gwp__progress--complete .gwp__progress-fill {
    background-color: var(--color-success, var(--color-foreground));
  }

  .gwp__progress-message {
    font-size: var(--font-size-xs);
    color: rgb(var(--color-foreground-rgb) / var(--opacity-70));
    margin: 0;
  }

  .gwp__progress--complete .gwp__progress-message {
    color: var(--color-success, var(--color-foreground));
    font-weight: var(--font-weight-medium);
  }

  .gwp__products {
    display: flex;
    flex-direction: column;
    gap: var(--gap-sm);
    margin-bottom: var(--margin-md);
  }

  .gwp__product-label {
    display: block;
    cursor: pointer;
    border: 1px solid var(--color-border);
    border-radius: var(--style-border-radius-inputs);
    padding: var(--padding-sm);
    transition: border-color var(--animation-speed) var(--animation-easing),
      background-color var(--animation-speed) var(--animation-easing);
  }

  .gwp__product-label:hover {
    border-color: var(--color-foreground);
    background-color: rgb(var(--color-foreground-rgb) / 0.05);
  }

  .gwp__product--selected .gwp__product-label {
    border-color: var(--color-foreground);
    background-color: rgb(var(--color-foreground-rgb) / 0.1);
  }

  .gwp__product-radio {
    position: absolute;
    opacity: 0;
    pointer-events: none;
  }

  .gwp__product-content {
    display: flex;
    align-items: center;
    gap: var(--gap-sm);
  }

  .gwp__product-image {
    flex-shrink: 0;
    width: 60px;
    height: 60px;
    border-radius: var(--style-border-radius-inputs);
    overflow: hidden;
  }

  .gwp__product-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .gwp__product-info {
    display: flex;
    flex-direction: column;
    gap: var(--gap-2xs);
    flex: 1;
  }

  .gwp__product-title {
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
  }

  .gwp__product-variant {
    font-size: var(--font-size-xs);
    color: rgb(var(--color-foreground-rgb) / var(--opacity-70));
  }

  .gwp__actions {
    display: flex;
    gap: var(--gap-sm);
    flex-wrap: wrap;
  }

  .gwp__add-button,
  .gwp__remove-button {
    flex: 1;
    min-width: fit-content;
  }

  .gwp__add-button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .gwp__products--hidden,
  .gwp__actions--hidden {
    display: none;
  }
{% endstylesheet %}

